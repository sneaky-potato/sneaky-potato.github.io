<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=content-type content="text/html"><meta name=viewport content="width=device-width,initial-scale=1"><title itemprop=name>Trivy, Go's init(), and the Magic of Dynamic Analyzer Discovery | Potato</title><meta property="og:title" content="Trivy, Go's init(), and the Magic of Dynamic Analyzer Discovery | Potato"><meta name=twitter:title content="Trivy, Go's init(), and the Magic of Dynamic Analyzer Discovery | Potato"><meta itemprop=name content="Trivy, Go's init(), and the Magic of Dynamic Analyzer Discovery | Potato"><meta name=application-name content="Trivy, Go's init(), and the Magic of Dynamic Analyzer Discovery | Potato"><meta property="og:site_name" content="Awesome hugo blog"><meta name=description content="go, open-source, design-patterns"><meta itemprop=description content="go, open-source, design-patterns"><meta property="og:description" content="go, open-source, design-patterns"><meta name=twitter:description content="go, open-source, design-patterns"><meta property="og:locale" content="en-us"><meta name=language content="en-us"><link rel=alternate hreflang=en href=https://sneaky-potato.github.io/blog/trivy-analyzers/ title><meta name=generator content="Hugo 0.152.1"><meta property="og:url" content="https://sneaky-potato.github.io/blog/trivy-analyzers/"><meta property="og:site_name" content="Potato"><meta property="og:title" content="Trivy, Go's init(), and the Magic of Dynamic Analyzer Discovery"><meta property="og:description" content="go, open-source, design-patterns"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2025-10-07T00:00:00+00:00"><meta property="article:modified_time" content="2025-10-07T00:00:00+00:00"><meta property="article:tag" content="Life"><meta name=twitter:card content="summary"><meta name=twitter:title content="Trivy, Go's init(), and the Magic of Dynamic Analyzer Discovery"><meta name=twitter:description content="go, open-source, design-patterns"><link rel=canonical href=https://sneaky-potato.github.io/blog/trivy-analyzers/><link href=/style.min.2d921c18cf1ec555ffc03d59a8adc211c402c68c930c27d6a0c306ab175a8d09.css rel=stylesheet><link href=/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css rel=stylesheet><link rel=apple-touch-icon sizes=180x180 href=/icons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/icons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/icons/favicon-16x16.png><link rel=mask-icon href=/icons/safari-pinned-tab.svg><link rel="shortcut icon" href=/favicon.ico><link rel=manifest href=https://sneaky-potato.github.io/site.webmanifest><meta name=msapplication-config content="/browserconfig.xml"><meta name=msapplication-TileColor content="#2d89ef"><meta name=theme-color content="#434648"><link rel=icon type=image/svg+xml href=/icons/favicon.svg><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity="sha512-fHwaWebuwA7NSF5Qg/af4UeDx9XqUpYpOGgubo3yWu+b2IQR4UeQwbb42Ti7gVAjNtVoI/I9TEoYeu9omwcC6g==" crossorigin=anonymous crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity="sha512-LQNxIMR5rXv7o+b1l8+N1EZMfhG7iFZ9HhnbJkTp4zjNr5Wvst75AqUeFDxeRUa7l5vEDyUiAip//r+EFLLCyA==" crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity="sha512-iWiuBS5nt6r60fCz26Nd0Zqe0nbk1ZTIQbl3Kv7kYsX+yKMUFHzjaH2+AnM6vp2Xs+gNmaBAVWJjSmuPw76Efg==" crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})'></script></head><body data-theme=dark class=notransition><script src=/js/theme.min.8961c317c5b88b953fe27525839672c9343f1058ab044696ca225656c8ba2ab0.js integrity="sha256-iWHDF8W4i5U/4nUlg5ZyyTQ/EFirBEaWyiJWVsi6KrA="></script><div class=navbar role=navigation><nav class=menu aria-label="Main Navigation"><a href=https://sneaky-potato.github.io/ class=logo><svg width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home"><title/><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
</a><input type=checkbox id=menu-trigger class=menu-trigger>
<label for=menu-trigger><span class=menu-icon><svg width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7H3.40726"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M.5 12.5V1.5c0-.552285.447715-1 1-1h11C13.0523.5 13.5.947715 13.5 1.5v11C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C.947715 13.5.5 13.0523.5 12.5z"/></svg></span></label><div class=trigger><ul class=trigger-container><li><a class=menu-link href=/>Home</a></li><li><a class="menu-link active" href=/blog/>Blog</a></li><li><a class=menu-link href=/about/>About</a></li><li><a class=menu-link href=/cv.pdf>CV</a></li><li class=menu-separator><span>|</span></li></ul><a id=mode href=#><svg class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg>
<svg class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg></a></div></nav></div><div class="wrapper post"><main class=page-content aria-label=Content><article><header class=header><h1 class=header-title>Trivy, Go's init(), and the Magic of Dynamic Analyzer Discovery</h1><div class=post-meta><time datetime=2025-10-07T00:00:00+00:00 itemprop=datePublished>Oct 7, 2025</time></div></header><div class=page-content><div class="lead !mb-9 text-xl">How Trivy Dynamically Discovers New File Format Analyzers in Go</div><h2 id=what>What?</h2><p>I want to discuss a particular design pattern in go through a <a href=https://github.com/aquasecurity/trivy/pull/8897>PR</a> which I raised in the open source project <a href=https://github.com/aquasecurity/trivy>trivy</a></p><h2 id=what-is-trivy>What is trivy?</h2><p><a href=https://trivy.dev>Trivy</a> is an open source vulnerability scanner. You could use Trivy to find vulnerabilities (CVE) & misconfigurations (IaC) across code repositories, binary artifacts, container images, Kubernetes clusters, and more.</p><p>Since it is open source it used in extensively in build and deploy pipelines across projects. I used trivy in my build pipelines to scan images, configuration, licenses and most importantly - <strong>vulnerabilities</strong> in the source code.</p><p>And when I got to know that trivy is written in go, I realized I could make a meaningful open source contribution in the <a href=https://github.com/aquasecurity/trivy>repository</a>. I want to talk about a design pattern used in trivy and how I contributed to add support for another file format in it.</p><h2 id=issue>Issue</h2><p>So I found this relevant issue while inspecting the repository on Github: <a href=https://github.com/aquasecurity/trivy/issues/8307>feat(nodejs): Bun support</a>. The issue talks about adding support for <a href=https://bun.sh/blog/bun-lock-text-lockfile>bun lockfile</a>.
For those who do not know, <a href=https://bun.sh/>bun</a> is a new javascript runtime, much like node, but faster. It comes with its own lock file <em>bun.lock</em> much like <em>package.json</em> as in the case with node projects.</p><p>Now bun.lock file has a structure and the issue talked about adding support for scanning this particular file only. You see, trivy already had the support for major file formats related to npm and node, but users wanted support for <strong>bun.lock</strong> file as well.</p><h2 id=solution>Solution</h2><p>The maintainers helped a lot, gave me pointers and solved my doubts while implementing the solution for this issue. I want to point out a certain nuance that trivy uses to analyze different file formats and how it was so easy to add support for yet another file format to it.</p><p>I raised 2 pull requests for this change, first I implemented a prerequisite <a href=https://github.com/aquasecurity/trivy/pull/8851/files>parser</a> and then an <a href=https://github.com/aquasecurity/trivy/pull/8897>analyzer for bun.lock</a>
I want you to look at the second PR.</p><h2 id=go-and-trivy>Go and trivy</h2><p>You see Trivy scans many file types:</p><ul><li>package-lock.json (npm)</li><li>Pipfile.lock (Python)</li><li>poetry.toml (Python)
And more…</li></ul><p>Each format requires a different analyzer. You can look at the file <a href=https://github.com/aquasecurity/trivy/pull/8897/files#diff-56193d94f68a465ac3eb687e19688481e7411394179e2e2d78fd68211b2b8d5c>pkg/fanal/analyzer/language/nodejs/bun/bun.go</a>
where I wrote an analyzer for <code>bun.lock</code> files. The package basically has the following important components:</p><ul><li>init function</li><li>bunLibraryAnalyzer struct</li><li>PostAnalyze method</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>analyzer</span>.<span style=color:#a6e22e>RegisterPostAnalyzer</span>(<span style=color:#a6e22e>analyzer</span>.<span style=color:#a6e22e>TypeBun</span>, <span style=color:#a6e22e>newBunLibraryAnalyzer</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>bunLibraryAnalyzer</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>logger</span>        <span style=color:#f92672>*</span><span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Logger</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lockParser</span>    <span style=color:#a6e22e>language</span>.<span style=color:#a6e22e>Parser</span> <span style=color:#75715e>// generic type definition for the parser</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>packageParser</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>packagejson</span>.<span style=color:#a6e22e>Parser</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newBunLibraryAnalyzer</span>(<span style=color:#a6e22e>_</span> <span style=color:#a6e22e>analyzer</span>.<span style=color:#a6e22e>AnalyzerOptions</span>) (<span style=color:#a6e22e>analyzer</span>.<span style=color:#a6e22e>PostAnalyzer</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>bunLibraryAnalyzer</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>logger</span>:        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>WithPrefix</span>(<span style=color:#e6db74>&#34;bun&#34;</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>lockParser</span>:    <span style=color:#a6e22e>bun</span>.<span style=color:#a6e22e>NewParser</span>(), <span style=color:#75715e>// specific type definition while constructing</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>packageParser</span>: <span style=color:#a6e22e>packagejson</span>.<span style=color:#a6e22e>NewParser</span>(),
</span></span><span style=display:flex><span>	}, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>a</span> <span style=color:#a6e22e>bunLibraryAnalyzer</span>) <span style=color:#a6e22e>PostAnalyze</span>(<span style=color:#a6e22e>_</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>input</span> <span style=color:#a6e22e>analyzer</span>.<span style=color:#a6e22e>PostAnalysisInput</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>analyzer</span>.<span style=color:#a6e22e>AnalysisResult</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ... a long implementation of the analyzer specific to bun.lock file</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Such implementations are present for different file formats as well.</p><h3 id=but-how-does-trivy-call-the-right-analyzer-for-the-right-file>But how does trivy call the right analyzer for the right file?</h3><p>If Trivy had to manually list every analyzer in a central switch statement, adding a new analyzer would require touching the core code every time.</p><p>This violates the Open/Closed Principle: software should be open for extension, closed for modification</p><p>This is where Trivy employs the go&rsquo;s <code>init()</code> function.</p><blockquote><p>In go, every package can define one or more init() functions:</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>bun</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Bun analyzer initialized&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Key points about <code>init()</code>:</p><ul><li>Called automatically once per package before main() starts</li><li>Useful for initialization logic that should run without explicit calls</li><li>Can be used to register types, plug-ins, or handlers dynamically</li></ul><p>Think of it as Go&rsquo;s &ldquo;automatic constructor for a package.&rdquo;</p><h3 id=dynamic-discovery-via-import-side-effect>Dynamic discovery via import side effect</h3><p>Trivy has a file pkg/fanal/analyzer/all/import.go:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_</span> <span style=color:#e6db74>&#34;github.com/aquasecurity/trivy/pkg/fanal/analyzer/language/nodejs/npm&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_</span> <span style=color:#e6db74>&#34;github.com/aquasecurity/trivy/pkg/fanal/analyzer/language/nodejs/bun&#34;</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>If you look at <a href=https://github.com/aquasecurity/trivy/pull/8897/files#diff-8d2e69ce6143d1b1e019dae4cc7952170076c578519082c130d801eec95a9aea>pkg/fanal/analyzer/all/import.go</a> file, this is where we import ALL the analyzers which are implemented in the trivy code base.</p><ul><li><code>_</code> means import for side effects only</li><li>go will import the package, run its <code>init()</code>, and then discard the package name</li><li>The side effect is that the analyzer registers itself in the global registry</li></ul><p>So by just adding an import here, your new analyzer is discovered automatically.</p><h2 id=go-init-as-a-plugin-hook>Go init() as a &ldquo;Plugin Hook&rdquo;</h2><p>Imagine every analyzer has a self-registration hook. Go automatically calls these hooks when the program starts. The core logic just says:</p><p>&ldquo;Hey analyzers, tell me which files you can handle.&rdquo;</p><p>This is essentially a plugin discovery system powered by <code>init()</code>.</p><h3 id=why-this-is-cool>Why This is Cool</h3><ul><li>Open/Closed Principle: add new analyzers without touching core code</li><li>Decoupled architecture: core logic doesn&rsquo;t care about specific analyzers</li><li>Plug-and-play: Only requirement is importing the package</li></ul><h2 id=summary>Summary</h2><p>Trivy&rsquo;s plugin/analyzer system is conceptually closer to virtual functions and inheritance than to the classical Visitor pattern.
In Trivy, each analyzer (like package-lock.json, Pipfile.lock, bun.lock) is a module that implements a common interface, something like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Analyzer</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Analyze</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>input</span> <span style=color:#a6e22e>analyzer</span>.<span style=color:#a6e22e>Input</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>analyzer</span>.<span style=color:#a6e22e>Result</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Required</span>(<span style=color:#a6e22e>filePath</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>info</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>FileInfo</span>) <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Each analyzer:</p><ul><li>Implements these methods (like overriding virtual functions).</li><li>Calls <code>analyzer.RegisterAnalyzer()</code> inside its <code>init()</code> to register itself with the global registry.</li></ul><p>So the spirit is identical:</p><blockquote><p>Define a common interface; allow many implementations; dispatch at runtime.</p></blockquote><p>The only difference is how the compiler/runtime achieves the polymorphism:</p><ul><li>Go uses interface type assertions (duck typing).</li><li>C++ uses vtables and virtual calls.</li></ul></div></article><script src=https://utteranc.es/client.js repo=sneaky-potato/sneaky-potato.github.io issue-term=pathname label=comment theme=github-dark-orange crossorigin=anonymous async></script></main></div><footer class=footer><span class=footer_item></span>&nbsp;<div class=footer_social-icons><a href=https://github.com/sneaky-potato target=_blank rel="noopener noreferrer me" title=Github><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></div><small class=footer_copyright>© 2025 Ashwani Kumar Kamal.</small></footer><a href=# title id=totop><svg width="48" height="48" fill="currentColor" stroke="currentColor" viewBox="0 96 960 960"><path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197z"/></svg>
</a><script src=https://sneaky-potato.github.io/js/main.min.35f435a5d8eac613c52daa28d8af544a4512337d3e95236e4a4978417b8dcb2f.js integrity="sha256-NfQ1pdjqxhPFLaoo2K9USkUSM30+lSNuSkl4QXuNyy8="></script></body></html>